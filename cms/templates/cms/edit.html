{% extends 'base.html' %}
{% load i18n %}

{% block content %}
  <form method="POST" enctype="multipart/form-data" class="cms">
    {% csrf_token %}
    {{form.media}}

    <section>
      <div class="wrapper">
        <div class="title">
          <h1>{{form.instance}}</h1>
        </div>
        {% if form.errors or formset.errors %}
          <div class="global_error">
            {% trans 'Please correct the error(s) below and save again' %}
          </div>
        {% endif %}
        {% for field in form %}
          {% include 'cms/formfield.html' with field=field %}
        {% endfor %}
      </div>
    </section>

    {% if formset %}
      {{formset.management_form}}
      {% for form in formset %}
        {{form.media}}
        {% for field in form.hidden_fields %}
          {{field}}
        {% endfor %}
        <section>
          <div class="wrapper">
            <h1>{{form.instance}}</h1>
            {% for field in form.visible_fields %}
              {% include 'cms/formfield.html' with field=field %}
            {% endfor %}
          </div>
        </section>
      {% endfor %}

      <section>
        <div class="wrapper">
          <div class="edit">
            <a href="{{formset_form_url}}">
              + {% trans 'new' %} {{formset_description}}
            </a>
          </div>
        </div>
      </section>
    {% endif %}

    <div class="edit page">
      <button>{% trans 'save' %}</button>
    </div>
  </form>
{% endblock %}

{% block extrabody %}
  <script type="text/javascript" src="/static/admin/js/urlify.js"></script>
  <script>
    var slugfield = document.getElementById('id_slug');
    var titlefield = document.getElementById('id_title');
    var typefield = document.getElementById('id_type');

    /* My own implementation of Django's prepopulate.js */

    if (slugfield && titlefield) {
        var virgin = slugfield.value === '';

        if (virgin) {
            titlefield.addEventListener('input', function(event) {
                if (virgin) {
                    slugfield.value = URLify(titlefield.value);
                }
            });
            slugfield.addEventListener('input', function(event) {
                virgin = false;
            });
        }
    }

    {% if fields_per_type %}
    /* Only show relevant fields */

    if (typefield) {
        function show_relevant_fields(type) {
            fields_per_type = {{fields_per_type|safe}};

            for (el of document.querySelectorAll('div.formfield')) {
                el.style.display = 'none';
            }

            for (field of fields_per_type[type]) {
                el = document.getElementById(field);
                console.log('showing ' + field)
                el.style.display = 'block';
            }
        }

        typefield.addEventListener('input', function(event) {
            console.log(typefield.value);
            show_relevant_fields(typefield.value.toLowerCase());
        });
        show_relevant_fields(typefield.value.toLowerCase());
    }
    {% endif %}
  </script>
{% endblock %}
