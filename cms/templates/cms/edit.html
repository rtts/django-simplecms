{% extends 'admin.html' %}
{% load static i18n %}

{% block title %}{% trans 'Edit' %} {{form.instance}}{% endblock %}

{% block content %}
  <form method="POST" enctype="multipart/form-data" class="cms">
    {% csrf_token %}
    {{form.media}}

    {% if form %}
      <section>
        <div class="wrapper">
          {% if form.errors or formset.errors %}
            <div class="global_error">
              {% trans 'Please correct the error(s) below and save again' %}
            </div>
          {% endif %}
          {% for field in form %}
            {% if field.field.widget.input_type == 'checkbox' %}
              {% include 'cms/formfield_checkbox.html' with field=field %}
            {% else %}
              {% include 'cms/formfield.html' with field=field %}
            {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {% if formset %}
      {{formset.management_form}}
      {% for form in formset %}
        {{form.media}}
        {% for field in form.hidden_fields %}
          {{field}}
        {% endfor %}
        <section>
          <div class="wrapper">
            <div class="subform">
              {% for field in form.visible_fields %}
                {% if field.name == 'DELETE' and not form.instance.pk %}
                  
                {% elif field.field.widget.input_type == 'checkbox' %}
                  {% include 'cms/formfield_checkbox.html' with field=field counter=forloop.parentloop.counter0 %}
                {% else %}
                  {% include 'cms/formfield.html' with field=field counter=forloop.parentloop.counter0 %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </section>
      {% endfor %}
    {% endif %}

    <div class="edit page">
      <button><img src="{% static 'cms/ok.svg' %}"></button>
    </div>
  </form>
{% endblock %}

{% block extrabody %}
  <script type="text/javascript" src="/static/admin/js/urlify.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function(event) {

        // Auto-resize <textarea's>

        var tx = document.getElementsByTagName('textarea');
        for (var i = 0; i < tx.length; i++) {
            tx[i].setAttribute('style', 'height:0;overflow-y:hidden;');
            tx[i].style.height = (tx[i].scrollHeight) + 'px';
            tx[i].addEventListener("input", OnInput, false);
        }
        function OnInput() {
            this.style.height = '0';
            this.style.height = (this.scrollHeight) + 'px';
        }

        // My own implementation of Django's prepopulate.js

        var slugfield = document.getElementById('id_slug');
        var titlefield = document.getElementById('id_title');
        if (slugfield && titlefield) {
            var virgin = slugfield.value === '';
            if (virgin) {
                titlefield.addEventListener('input', function(event) {
                    if (virgin) {
                        slugfield.value = URLify(titlefield.value);
                    }
                });
                slugfield.addEventListener('input', function(event) {
                    virgin = false;
                });
            }
        }

        // Auto-hide non-relevant fields, based on type field

        {% if fields_per_type %}
        var typefield = document.getElementById('id_type');
        fields_per_type = {{fields_per_type|safe}};

        if (typefield) {
            function show_relevant_fields(type) {
                for (el of document.querySelectorAll('div.formfield')) {
                    el.style.display = 'none';
                }

                for (field of fields_per_type[type]) {
                    el = document.getElementById(field);
                    el.style.display = 'block';
                }
            }

            typefield.addEventListener('input', function(event) {
                show_relevant_fields(typefield.value.toLowerCase());
            });
            show_relevant_fields(typefield.value.toLowerCase());
        }

        subforms = document.querySelectorAll('div.subform');
        for (let i = 0; i < subforms.length; ++i) {
            let typefield = document.getElementById('id_sections-' + i + '-type');

            function show_relevant_fields(type) {
                for (field of subforms[i].querySelectorAll('div.formfield')) {
                    field.style.display = 'none';
                }

                delete_checkbox = document.getElementById('DELETE' + i);
                if (delete_checkbox) {
                    delete_checkbox.style.display = 'block';
                }
                for (field of fields_per_type[type]) {
                    el = document.getElementById(field + i);
                    el.style.display = 'block';
                }
            }

            typefield.addEventListener('input', function(event) {
                (show_relevant_fields(typefield.value.toLowerCase()));
            });
            show_relevant_fields(typefield.value.toLowerCase());
        }
        {% endif %}
    });
  </script>
{% endblock %}
